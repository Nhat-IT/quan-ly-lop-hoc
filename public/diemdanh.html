<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Điểm Danh Sinh Viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #0d6efd; --danger-bg: #fff0f3; --danger-border: #ffccd5; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }
        
        /* CĂN GIỮA TIÊU ĐỀ MÔN HỌC */
        .page-header-title { text-align: center; flex-grow: 1; font-weight: 700; color: #333; font-size: 1.2rem; }
        
        /* THANH CÔNG CỤ (FILTERS) */
        .filter-bar { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-select-sm, .form-control-sm { height: 38px; }

        /* BẢNG ĐIỂM DANH */
        .table-custom thead th { background-color: #f1f5f9; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; padding: 12px; border-bottom: 2px solid #e2e8f0; vertical-align: middle; }
        .student-row { border-bottom: 1px solid #f0f0f0; transition: all 0.2s; }
        .student-row:hover { background-color: #f9fafb; }
        
        /* HIỆU ỨNG KHI VẮNG */
        .student-row.is-absent { background-color: var(--danger-bg); }
        .student-row.is-absent td { color: #d63384; font-weight: 500; }
        
        /* CHECKBOX CUSTOM */
        .form-check-input { width: 1.4em; height: 1.4em; cursor: pointer; border: 2px solid #ccc; }
        .is-absent .form-check-input { background-color: #dc3545; border-color: #dc3545; }

        .sticky-header { background: white; position: sticky; top: 0; z-index: 1000; padding: 10px 0; border-bottom: 1px solid #eee; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .bottom-bar { position: fixed; bottom: 0; width: 100%; left: 0; background: white; border-top: 1px solid #eee; padding: 15px; z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div class="sticky-header">
        <div class="container d-flex align-items-center">
            <a href="index.html" class="btn btn-outline-secondary btn-sm me-3 border-0"><i class="fas fa-arrow-left fa-lg"></i></a>
            <div class="page-header-title" id="displaySubjectName">--</div>
            <div class="ms-auto" style="width: 40px;"></div> </div>
    </div>

    <div class="container mt-4">
        <div class="filter-bar">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <select class="form-select text-primary fw-bold" id="semesterSelect" onchange="filterSubjectsBySemester()">
                        <option value="HK1">HK1</option>
                        <option value="HK2">HK2</option>
                        <option value="HK3">HK3</option>
                    </select>
                </div>
                
                <div class="col">
                    <input type="text" class="form-control" id="searchInput" placeholder="Tìm tên hoặc MSSV..." onkeyup="filterList()">
                </div>

                <div class="col-auto" style="min-width: 200px;">
                    <select class="form-select text-primary fw-bold" id="subjectSelect" onchange="changeSubject()"></select>
                </div>

                <div class="col-auto">
                    <select class="form-select text-secondary fw-bold" id="statusFilter" onchange="filterList()">
                        <option value="all">Tất cả trạng thái</option>
                        <option value="absent">Chỉ hiện Vắng</option>
                    </select>
                </div>
            </div>
            
            <div class="row g-2 mt-2 align-items-center">
                <div class="col-auto"><label class="small fw-bold text-muted me-2">Ngày:</label></div>
                <div class="col-auto"><input type="date" class="form-control fw-bold" id="todayDate"></div>
                
                <div class="col-auto ms-3"><label class="small fw-bold text-muted me-2">Buổi:</label></div>
                <div class="col-auto">
                    <select class="form-select fw-bold" id="sessionTime">
                        <option>Sáng</option><option>Chiều</option><option>Tối</option>
                    </select>
                </div>

                <div class="col text-end">
                    <input type="file" id="fileInput" hidden onchange="handleFileSelect(event)">
                    <button class="btn btn-success me-2" onclick="document.getElementById('fileInput').click()"><i class="fas fa-file-excel"></i> Nhập Excel</button>
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" onclick="submitAttendance()"><i class="fas fa-save me-1"></i> LƯU ĐIỂM DANH</button>
                </div>
            </div>
            <div class="mt-1 text-muted small text-end"><i class="fas fa-user-tie me-1"></i> <span id="displayTeacherName">--</span></div>
        </div>

        <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
            <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                <span class="fw-bold text-secondary">DANH SÁCH SINH VIÊN</span>
                <span class="badge bg-light text-dark border">Sĩ số: <b id="studentCount">0</b></span>
            </div>
            <div class="table-responsive">
                <table class="table table-custom table-hover mb-0 align-middle">
                    <thead>
                        <tr>
                            <th class="text-center" width="60">STT</th>
                            <th>Họ và Tên</th>
                            <th>Mã Số SV</th>
                            <th>Lớp</th>
                            <th class="text-center" width="120">Vắng</th>
                        </tr>
                    </thead>
                    <tbody id="studentListContainer">
                        </tbody>
                </table>
            </div>
            
            <div id="emptyState" class="text-center py-5 d-none">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p class="text-muted fw-bold">Chưa có dữ liệu sinh viên.</p>
                <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fileInput').click()">Nhập từ Excel ngay</button>
            </div>
        </div>
    </div>

    <div class="bottom-bar d-flex justify-content-between align-items-center">
        <div><span class="badge bg-secondary" id="syncStatus">Sẵn sàng</span></div>
        <div>Tổng vắng: <span class="text-danger fw-bold fs-3" id="countAbsent">0</span> sinh viên</div>
    </div>

    <div class="modal fade" id="addSubjectModal">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('todayDate').valueAsDate = new Date();
        let allSubjects = [];
        let currentStudents = [];

        // --- 1. LẮNG NGHE SỰ KIỆN ĐỔI NGÀY/BUỔI ---
        document.getElementById('todayDate').addEventListener('change', reloadData);
        document.getElementById('sessionTime').addEventListener('change', reloadData);

        async function init() {
            try {
                const res = await fetch('/api/data/subjects');
                allSubjects = await res.json();
                if(!document.getElementById('semesterSelect').value) document.getElementById('semesterSelect').value = "HK1";
                filterSubjectsBySemester();
            } catch (e) { console.error(e); }
        }

        function filterSubjectsBySemester() {
            const sem = document.getElementById('semesterSelect').value;
            const select = document.getElementById('subjectSelect');
            select.innerHTML = '';
            
            const filtered = allSubjects.filter(s => (s.semester || 'HK1') === sem);
            if(filtered.length === 0) {
                select.innerHTML = '<option value="">-- Trống --</option>';
                document.getElementById('displaySubjectName').innerText = "Chưa có môn học";
                currentStudents = []; renderList();
                return;
            }

            filtered.forEach(s => select.add(new Option(s.subject_name, s.id)));
            changeSubject();
        }

        async function changeSubject() {
            const id = document.getElementById('subjectSelect').value;
            if(!id) return;
            
            const sub = allSubjects.find(s => s.id == id);
            if(sub) {
                document.getElementById('displaySubjectName').innerText = sub.subject_name;
                document.getElementById('displayTeacherName').innerText = sub.teacher_name || "Chưa cập nhật GV";
            }

            // 1. Load danh sách SV của môn này
            try {
                const res = await fetch(`/api/data/students/${id}`);
                currentStudents = await res.json();
            } catch(e) { currentStudents = []; }

            // 2. Render bảng (ban đầu tất cả có mặt)
            renderList();

            // 3. Gọi API kiểm tra xem ngày này đã lưu điểm danh chưa
            await loadSavedAttendance();
        }

        function reloadData() {
            if(currentStudents.length > 0) loadSavedAttendance();
        }

        // --- HÀM QUAN TRỌNG: LOAD DỮ LIỆU TỪ DB LÊN GIAO DIỆN ---
        async function loadSavedAttendance() {
            const subjectId = document.getElementById('subjectSelect').value;
            const date = document.getElementById('todayDate').value;
            const session = document.getElementById('sessionTime').value;
            
            // Bước 1: Reset toàn bộ về trạng thái "Có mặt"
            document.querySelectorAll('.student-row').forEach(r => {
                r.classList.remove('is-absent');
                r.querySelector('.absent-chk').checked = false;
                r.querySelector('.reason-input').value = '';
                r.querySelector('.reason-box').classList.add('d-none');
            });
            updateCount();
            document.getElementById('syncStatus').innerText = "Đang kiểm tra...";

            try {
                // Bước 2: Gọi API Check
                const res = await fetch(`/api/data/attendance/check?subject_id=${subjectId}&session_date=${date}&session_time=${session}`);
                if(res.ok) {
                    const savedData = await res.json();
                    
                    if(savedData.length > 0) {
                        // Bước 3: Nếu có dữ liệu cũ, map vào bảng
                        savedData.forEach(rec => {
                            if(rec.is_absent) {
                                // Tìm dòng có data-id trùng với student_id
                                const row = document.getElementById(`row-${rec.student_id}`);
                                if(row) {
                                    row.classList.add('is-absent');
                                    row.querySelector('.absent-chk').checked = true;
                                    
                                    // Điền lý do và hiển thị ô nhập
                                    const reasonInput = row.querySelector('.reason-input');
                                    reasonInput.value = rec.reason || '';
                                    if(rec.reason) row.querySelector('.reason-box').classList.remove('d-none');
                                }
                            }
                        });
                        updateCount();
                        document.getElementById('syncStatus').innerText = "Dữ liệu đã lưu";
                        document.getElementById('syncStatus').className = "badge bg-success";
                    } else {
                        document.getElementById('syncStatus').innerText = "Chưa điểm danh";
                        document.getElementById('syncStatus').className = "badge bg-warning text-dark";
                    }
                }
            } catch(e) { console.error("Lỗi load check:", e); }
        }

        function renderList() {
            const list = document.getElementById('studentListContainer');
            list.innerHTML = '';
            document.getElementById('studentCount').innerText = currentStudents.length;

            if(currentStudents.length === 0) {
                document.getElementById('emptyState').classList.remove('d-none');
                return;
            }
            document.getElementById('emptyState').classList.add('d-none');

            currentStudents.forEach((sv, i) => {
                const tr = document.createElement('tr');
                tr.className = 'student-row';
                tr.id = `row-${sv.id}`; // ID để tìm kiếm khi load lại dữ liệu
                tr.dataset.name = sv.full_name.toLowerCase();
                tr.dataset.mssv = sv.mssv.toLowerCase();
                
                tr.innerHTML = `
                    <td class="text-center fw-bold text-muted">${i+1}</td>
                    <td>
                        <div class="fw-bold text-dark">${sv.full_name}</div>
                        <div class="reason-box mt-1 d-none">
                            <input type="text" class="form-control form-control-sm reason-input text-danger" placeholder="Nhập lý do vắng (VD: Ốm)...">
                        </div>
                    </td>
                    <td>${sv.mssv}</td>
                    <td class="text-primary fw-bold small">${sv.class_name}</td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input absent-chk" onchange="toggleAbsent(${sv.id})">
                    </td>
                `;
                list.appendChild(tr);
            });
            updateCount();
        }

        function toggleAbsent(id) {
            const row = document.getElementById(`row-${id}`);
            const chk = row.querySelector('.absent-chk');
            const reasonBox = row.querySelector('.reason-box');
            
            if(chk.checked) {
                row.classList.add('is-absent');
                reasonBox.classList.remove('d-none');
                reasonBox.querySelector('input').focus();
            } else {
                row.classList.remove('is-absent');
                reasonBox.classList.add('d-none');
                reasonBox.querySelector('input').value = ''; // Xóa lý do nếu bỏ tích
            }
            updateCount();
        }

        function updateCount() {
            const count = document.querySelectorAll('.absent-chk:checked').length;
            document.getElementById('countAbsent').innerText = count;
        }

        function filterList() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value; // all hoặc absent

            document.querySelectorAll('.student-row').forEach(row => {
                const name = row.dataset.name;
                const mssv = row.dataset.mssv;
                const isAbsent = row.classList.contains('is-absent');

                let matchText = name.includes(txt) || mssv.includes(txt);
                let matchStatus = (status === 'all') || (status === 'absent' && isAbsent);

                row.style.display = (matchText && matchStatus) ? '' : 'none';
            });
        }

        async function submitAttendance() {
            const data = Array.from(document.querySelectorAll('.student-row')).map(row => {
                const id = row.id.replace('row-', '');
                const isAbsent = row.querySelector('.absent-chk').checked;
                const reason = row.querySelector('.reason-input').value;
                return { student_id: id, is_absent: isAbsent ? 1 : 0, reason: reason };
            });

            try {
                await fetch('/api/data/attendance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        subject_id: document.getElementById('subjectSelect').value,
                        session_date: document.getElementById('todayDate').value,
                        session_time: document.getElementById('sessionTime').value,
                        attendance_data: data
                    })
                });
                alert('Đã lưu dữ liệu thành công!');
                loadSavedAttendance(); // Load lại để cập nhật trạng thái
            } catch(e) { alert('Lỗi khi lưu'); }
        }

        // Logic Import Excel (Giữ nguyên)
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const wb = XLSX.read(evt.target.result, {type: 'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(ws); // Simplest read
                // Mapper logic here (giống code cũ của bạn)
                const students = data.map(row => ({
                    mssv: row['Mã SV'] || row['MSSV'],
                    full_name: row['Họ tên'] || row['Họ và tên'],
                    class_name: '25TH' // Demo
                })).filter(s => s.mssv && s.full_name);
                
                if(students.length > 0) sendImport(students);
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }
        
        async function sendImport(students) {
            const subId = document.getElementById('subjectSelect').value;
            await fetch('/api/data/students/import', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subject_id: subId, students: students })
            });
            alert("Đã nhập danh sách!"); changeSubject();
        }

        init();
    </script>
</body>
</html>